<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>用户反馈管理</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
  background:#f4f6f8;
  color:#202124;
  padding:20px;
}
h1{
  font-size:28px;
  margin-bottom:20px;
  text-align:center;
  color:#1a73e8;
}
#list{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(320px,1fr));
  gap:16px;
}
.card{
  background:#fff;
  border-radius:12px;
  padding:16px;
  box-shadow:0 2px 4px rgba(0,0,0,.1);
  display:flex;
  flex-direction:column;
  transition:transform .2s;
}
.card:hover{
  transform: translateY(-2px);
}
.card p{
  margin:6px 0;
  word-break:break-word;
}
.label{
  font-weight:500;
  color:#5f6368;
}
.time{
  font-size:13px;
  color:#80868b;
}
.actions{
  margin-top:12px;
}
button{
  padding:8px 14px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-size:14px;
  margin-right:6px;
  transition:all .2s;
}
button:hover:not(:disabled){
  opacity:0.85;
}
.reply{
  background:#1a73e8;
  color:#fff;
}
.delete{
  background:#d93025;
  color:#fff;
}
.reply:disabled{
  background:#9aa0a6;
  cursor:not-allowed;
}
#msg{
  text-align:center;
  margin:16px 0;
  color:#d93025;
  font-weight:500;
}

/* 弹窗样式优化 */
#modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  align-items:center;
  justify-content:center;
  z-index:100;
}
.modal-box{
  background:#fff;
  width:95%;
  max-width:600px;
  border-radius:12px;
  padding:24px;
  box-shadow:0 4px 20px rgba(0,0,0,.2);
  animation:fadeIn 0.2s ease-out;
}
@keyframes fadeIn{
  from{opacity:0; transform:scale(0.95);}
  to{opacity:1; transform:scale(1);}
}
.modal-box h2{
  margin-bottom:16px;
  font-size:24px;
  color:#1a73e8;
}
.modal-box input, .modal-box textarea{
  width:100%;
  padding:12px;
  border:1px solid #dadce0;
  border-radius:6px;
  margin-bottom:16px;
  font-size:15px;
}
.modal-box input:focus, .modal-box textarea:focus{
  border-color:#1a73e8;
  outline:none;
}
.modal-box textarea{
  height:160px;
  resize:none;
}
.modal-actions{
  text-align:right;
}
.modal-actions button{
  margin-left:10px;
}
</style>
</head>
<body>

<h1>用户反馈管理</h1>
<div id="list">加载中...</div>
<div id="msg"></div>

<!-- 回复弹窗 -->
<div id="modal">
  <div class="modal-box">
    <h2>回复用户反馈</h2>
    <input id="replyEmail" type="email" placeholder="收件人邮箱">
    <input id="replySubject" placeholder="邮件主题（可修改）">
    <textarea id="replyText" placeholder="请输入回复内容..."></textarea>
    <div class="modal-actions">
      <button onclick="closeModal()">取消</button>
      <button class="reply" onclick="sendReply()">发送</button>
    </div>
  </div>
</div>

<script>
let feedbackList = [];
let currentIndex = -1;
const MAIL_URL = 'https://resend-mail-worker.cnjszzy.workers.dev'; // 替换为你的邮件 Worker/GAS URL

// 加载反馈列表
async function loadFeedback(){
  try{
    const res = await fetch('/api/feedback/list');
    feedbackList = await res.json();
    const box = document.getElementById('list');
    if(!feedbackList.length){
      box.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:#5f6368;">暂无用户反馈</p>';
      return;
    }
    box.innerHTML = '';
    feedbackList.forEach((f, i)=>{
      const card = document.createElement('div');
      card.className = 'card';
      const hasEmail = f.contact && f.contact.includes('@');
      card.innerHTML = `
        <p><span class="label">反馈内容：</span>${escapeHtml(f.message)}</p>
        <p><span class="label">联系方式：</span>${f.contact || '未填写'}</p>
        <p class="time">提交时间：${new Date(f.time).toLocaleString()}</p>
        <div class="actions">
          <button class="reply" ${hasEmail?'':'disabled'} onclick="openReply(${i})">邮件回复</button>
          <button class="delete" onclick="removeFeedback(${i})">删除</button>
        </div>
      `;
      box.appendChild(card);
    });
  }catch(e){
    document.getElementById('msg').textContent = '加载失败：'+e.message;
  }
}

// 打开回复弹窗
function openReply(index){
  currentIndex = index;
  const f = feedbackList[index];
  document.getElementById('replyEmail').value = f.contact || '';
  document.getElementById('replySubject').value = `[反馈回复#${f.time ? new Date(f.time).getTime() : Date.now()}] 关于您的反馈`;
  document.getElementById('replyText').value = '';
  document.getElementById('modal').style.display = 'flex';
}

// 关闭弹窗
function closeModal(){
  document.getElementById('modal').style.display = 'none';
}

// 发送邮件
async function sendReply(){
  const email = document.getElementById('replyEmail').value.trim();
  const subject = document.getElementById('replySubject').value.trim();
  const text = document.getElementById('replyText').value.trim();
  if(!email){ alert('请输入收件人邮箱'); return; }
  if(!subject){ alert('请输入邮件主题'); return; }
  if(!text){ alert('请输入回复内容'); return; }

  try {
    const resp = await fetch(MAIL_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ to: email, subject: subject, content: text })
    });
    if(!resp.ok){
      const txt = await resp.text();
      alert("❌ 发送失败:\n" + txt);
      return;
    }
    alert("✅ 邮件发送成功！");
    closeModal();
  } catch(e){
    alert("❌ 网络错误:\n" + e);
  }
}

// 删除反馈
async function removeFeedback(index){
  if(!confirm('确定要删除这条反馈吗？')) return;
  const res = await fetch('/api/feedback/delete',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ index })
  });
  if(res.ok){
    loadFeedback();
  }else{
    alert('删除失败');
  }
}

// HTML 转义
function escapeHtml(str){
  return str.replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));
}

loadFeedback();
</script>

</body>
</html>
