<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>链接管理</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>
<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system;
  background: #f4f6f8;
}
header {
  background: #1f2937;
  color: #fff;
  padding: 14px 20px;
}
.container {
  display: flex;
  height: calc(100vh - 52px);
}
.editor {
  width: 320px;
  background: #fff;
  border-right: 1px solid #e5e7eb;
  padding: 16px;
}
.editor label {
  display:block;
  font-size:13px;
  margin-top:10px;
}
.editor input, .editor select {
  width:100%;
  padding:6px;
  margin-top:4px;
}
.editor button {
  width:100%;
  margin-top:10px;
  padding:8px;
  border:none;
  border-radius:4px;
}
.btn-apply { background:#409eff;color:#fff;}
.btn-clear { background:#9ca3af;color:#fff;}
.btn-save { background:#22c55e;color:#fff;font-weight:600;}
.cards {
  flex:1;
  padding:16px;
  overflow:auto;
}
.category-block {
  margin-bottom:24px;
}
.category-block h3 {
  margin:12px 0;
  font-size:16px;
  color:#1f2937;
  border-bottom:1px solid #e5e7eb;
  padding-bottom:4px;
}
.card-grid {
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); /* 减小宽度 */
  gap:12px;
}
.card {
  background:#fff;
  padding:8px; /* 减小padding */
  border-radius:6px;
  box-shadow:0 2px 6px rgba(0,0,0,.08);
  height: 90px; /* 减小高度 */
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}
.card .info {
  flex: 1;
  overflow: hidden;
}
.card .name-domain {
  font-weight: bold;
  font-size: 14px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.card .desc {
  font-size: 12px;
  color: #6b7280;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.card .actions {
  margin-top:6px; /* 减小margin */
  display:flex;
  gap:8px;
}
.card button {
  flex:1;
  font-size:12px;
}
</style>
</head>
<body>
<header>链接管理</header>
<div class="container">
<div class="editor">
  <label>一级分类</label>
  <select id="cat"></select>
  <label>二级分类</label>
  <select id="sub"></select>
  <label>名称</label>
  <input id="linkName">
  <label>网址</label>
  <input id="url">
  <label>描述</label>
  <input id="desc">
  <button class="btn-apply" onclick="applyEdit()">应用修改</button>
  <button class="btn-clear" onclick="clearForm()">清空</button>
  <button class="btn-save" onclick="saveKV()">保存到 KV</button>
  <!-- 操作说明 -->
  <div style="
        margin-top:16px;
        padding:12px;
        background:#fef9c3;
        border-left:4px solid #facc15;
        border-radius:6px;
        font-size:13px;
        color:#92400e;
        line-height:1.4;">
    <strong>操作提示：</strong><br>
    1️⃣ 请先添加或编辑链接，然后点击“应用修改”确认更改。<br>
    2️⃣ 修改完成后，务必点击“保存到 KV”按钮，否则修改不会永久生效。<br>
    3️⃣ 删除链接后，也需保存到 KV 才会生效。<br>
    ⚠️ 请确保名称和网址必填，否则无法应用修改。
  </div>
</div>
<div class="cards" id="cardsContainer">
  <!-- 分类分组卡片显示 -->
</div>
</div>
<script>
let xmlDoc;
let editRef = null;
fetch('/api/data')
  .then(r => r.text())
  .then(t => {
    xmlDoc = new DOMParser().parseFromString(t,'text/xml');
    buildSelectors();
    renderCards();
  });
function buildSelectors(){
  cat.innerHTML='';
  xmlDoc.querySelectorAll('category').forEach(c=>{
    const o=document.createElement('option');
    o.value=o.textContent=c.getAttribute('name');
    cat.appendChild(o);
  });
  buildSub();
  cat.onchange=buildSub;
}
function buildSub(){
  sub.innerHTML='';
  xmlDoc.querySelectorAll(`category[name="${cat.value}"] subcategory`)
    .forEach(s=>{
      const o=document.createElement('option');
      o.value=o.textContent=s.getAttribute('name');
      sub.appendChild(o);
    });
}
function renderCards(){
  const container = document.getElementById('cardsContainer');
  container.innerHTML='';
  xmlDoc.querySelectorAll('category').forEach(c=>{
    const catBlock = document.createElement('div');
    catBlock.className='category-block';
    catBlock.innerHTML=`<h3>${c.getAttribute('name')}</h3>`;
    c.querySelectorAll('subcategory').forEach(s=>{
      const subLinks = s.querySelectorAll('link');
      if(subLinks.length===0) return;
      const subHeader = document.createElement('h4');
      subHeader.style.margin='8px 0 4px';
      subHeader.style.fontSize='14px';
      subHeader.style.color='#374151';
      subHeader.textContent = s.getAttribute('name');
      catBlock.appendChild(subHeader);
      const grid = document.createElement('div');
      grid.className='card-grid';
      subLinks.forEach(l=>{
        const d=document.createElement('div');
        d.className='card';
        d._ref=l;
        const domain = new URL(l.getAttribute('url')).hostname.replace('www.', '');
        d.innerHTML=`
<div class="info">
  <div class="name-domain">${l.getAttribute('name')} - ${domain}</div>
  <div class="desc">${l.getAttribute('desc') || ''}</div>
</div>
<div class="actions">
  <button onclick="editLink(this)">编辑</button>
  <button onclick="delLink(this)">删除</button>
</div>`;
        grid.appendChild(d);
      });
      catBlock.appendChild(grid);
      // 添加拖拽排序
      new Sortable(grid, {
        animation: 150,
        onEnd: (evt) => {
          const oldIndex = evt.oldIndex;
          const newIndex = evt.newIndex;
          const parentSub = s;
          const links = Array.from(parentSub.querySelectorAll('link'));
          const movedLink = links.splice(oldIndex, 1)[0];
          links.splice(newIndex, 0, movedLink);
          // 更新 XML 结构
          parentSub.innerHTML = '';
          links.forEach(link => parentSub.appendChild(link));
          renderCards(); // 重新渲染
        }
      });
    });
    container.appendChild(catBlock);
  });
}
function editLink(btn){
  const l = btn.closest('.card')._ref;
  editRef = l;
  linkName.value = l.getAttribute('name') || '';
  url.value = l.getAttribute('url') || '';
  desc.value = l.getAttribute('desc') || '';
  cat.value = l.closest('category').getAttribute('name');
  buildSub();
  sub.value = l.closest('subcategory').getAttribute('name');
}
function applyEdit(){
  if(!linkName.value || !url.value){
    alert('名称和网址不能为空');
    return;
  }
  if(!editRef){
    const s = xmlDoc.querySelector(
      `category[name="${cat.value}"] subcategory[name="${sub.value}"]`
    );
    editRef = xmlDoc.createElement('link');
    s.appendChild(editRef);
  }
  editRef.setAttribute('name', linkName.value);
  editRef.setAttribute('url', url.value);
  editRef.setAttribute('desc', desc.value);
  clearForm();
  renderCards();
}
function delLink(btn){
  if(confirm('确定删除？')){
    btn.closest('.card')._ref.remove();
    renderCards();
  }
}
function clearForm(){
  linkName.value = url.value = desc.value = '';
  editRef = null;
}
function saveKV(){
  const xml = new XMLSerializer().serializeToString(xmlDoc);
  fetch('/api/save',{method:'POST',body:xml})
    .then(()=>alert('已保存到 KV'));
}
</script>
</body>
</html>
